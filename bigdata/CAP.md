> ## `CAP`

CAP是 `Consistency`、`Availability`、`Partition tolerance`三个词语的缩写，分别表示`一致性`、`可用性`、`分区容忍性`。

>> ### `C - Consistency`：

​`一致性`是指写操作后的读操作可以读取到`最新的`数据状态，当数据分布在多个节点上，从任意结点读取到的数据都是最新的状态。

**`如何实现一致性？`**

- 写入主数据库后要将数据同步到从数据库。
- 写入主数据库后，在向从数据库同步期间要将从数据库锁定，待同步完成后再释放锁，以免在新数据写入成功后，向从数据库查询到旧的数据。

**`分布式系统一致性的特点`**

- 由于存在数据同步的过程，写操作的响应会有一定的延迟。
- 为了保证数据一致性会对资源暂时锁定，待数据同步完成释放锁定资源。
- 如果请求数据同步失败的结点则会返回错误信息，一定不会返回旧数据。

>> ### `A - Availability` ：

​ `可用性`是指任何事务操作都可以得到响应结果，且不会出现响应超时或响应错误。

**`如何实现可用性？`**
- 写入主数据库后要将数据同步到从数据库。
- 由于要保证从数据库的可用性，不可将从数据库中的资源进行锁定。
- 即时数据还没有同步过来，从数据库也要返回要查询的数据，哪怕是旧数据，如果连旧数据也没有则可以按照约定返回一个默认信息，但不能返回错误或响应超时。

​**`分布式系统可用性的特点：`**
- 所有请求都有响应，且不会出现响应超时或响应错误。

>> ### `P - Partition tolerance` ：

​通常分布式系统的各各结点部署在不同的子网，这就是网络分区，不可避免的会出现由于网络问题而导致结点之间通信失败，此时仍可对外提供服务，这叫`分区容忍性`。

**`​如何实现分区容忍性？`**
- 尽量使用异步取代同步操作，例如使用异步方式将数据从主数据库同步到从数据，这样结点之间能有效的实现松耦合。
- 添加从数据库结点，其中一个从结点挂掉其它从结点提供服务。

​**`分布式分区容忍性的特点：`**
- 分区容忍性是分布式系统具备的基本能力。

>> **`在所有分布式事务场景中不会同时具备CAP三个特性，因为在具备了P的前提下C和A是不能共存的。`**

- 如果要实现`C则必须保证数据一致性`，在数据同步的时候为防止向从数据库查询不一致的数据则需要将从数据库数据锁定，待同步完成后解锁，如果同步失败从数据库要返回错误信息或超时信息。
- 如果要实现`A则必须保证数据可用性`，不管任何时候都可以向从数据查询数据，则不会响应超时或返回错误信息。

对于多数大型互联网应用的场景，结点众多、部署分散，而且现在的集群规模越来越大，所以节点故障、网络故障是常态，而且要保证服务可用性达到N个9（99.99..%），并要达到良好的响应性能来提高用户体验，因此一般都会做出如下选择：`保证P和A，舍弃C强一致，保证最终一致性`。

1. `AP`: 放弃一致性，追求分区容忍性和可用性。`这是很多分布式系统设计时的选择`。
2. `CP`: 放弃可用性，追求一致性和分区容错性，我们的zookeeper其实就是追求的强一致，又比如跨行转账，一次转账请求要等待双方银行系统都完成整个事务才算完成。
3. `CA`: 放弃分区容忍性，即不进行分区，不考虑由于网络不通或结点挂掉的问题，则可以实现一致性和可用性。那么系统将不是一个标准的分布式系统，我们最常用的关系型数据就满足了CA。